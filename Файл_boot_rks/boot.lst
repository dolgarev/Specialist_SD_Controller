0001   0000                  .org 0h
0002   0000             
0003   0000             CLC_PORT        = 0F001h
0004   0000             DATA_PORT       = 0F002h
0005   0000             CTL_PORT        = 0F003h
0006   0000             CLC_BIT         = 80h;
0007   0000             SEND_MODE       = 10010000b ; Настройка: 1 0 0 A СH 0 B CL   1=ввод 0=вывод
0008   0000             RECV_MODE       = 10011001b
0009   0000             
0010   0000             ERR_START  	    = 040h
0011   0000             ERR_WAIT   	    = 041h
0012   0000             ERR_OK_DISK     = 042h
0013   0000             ERR_OK          = 043h
0014   0000             ERR_OK_READ	    = 044h
0015   0000             ERR_OK_ENTRY	  = 045h
0016   0000             ERR_OK_WRITE	  = 046h
0017   0000             ERR_OK_RKS	    = 047h
0018   0000             
0019   0000             Entry:
0020   0000                  ; Первым этапом происходит синхронизация с контроллером
0021   0000                  ; 256 попыток. Для этого в регистр C заносится 0
0022   0000             
0023   0000                  ; А в стек заносится адрес перезагрузки 0C000h
0024   0000             
0025   0000 01 00 C0         LXI	B, 0C000h
0026   0003 C5               PUSH	B     
0027   0004             
0028   0004 C3 19 00         JMP	Boot
0029   0007             
0030   0007 00               NOP
0031   0008             
0032   0008             ;----------------------------------------------------------------------------
0033   0008             ; Отправка и прием байта
0034   0008             
0035   0008             Rst1:
0036   0008 2B               DCX	H		; HL = CLC_PORT
0037   0009 36 80            MVI	M, CLC_BIT
0038   000B 36 00            MVI	M, 0
0039   000D 23               INX	H		; HL = DATA_PORT
0040   000E 7E               MOV	A, M
0041   000F C9               RET
0042   0010             
0043   0010             ;----------------------------------------------------------------------------
0044   0010             ; Ожидание готовности МК
0045   0010             
0046   0010             Rst2:
0047   0010             WaitForReady:
0048   0010 CF               Rst	1
0049   0011 FE 41            CPI	ERR_WAIT
0050   0013 CA 10 00         JZ		WaitForReady
0051   0016 C9               RET
0052   0017             
0053   0017             ;----------------------------------------------------------------------------
0054   0017             
0055   0017             RetrySync:
0056   0017                  ; Попытки
0057   0017 0D               DCR C
0058   0018 C8               RZ				; Ошибка синхронизации, перезагрузка
0059   0019             
0060   0019             Boot:
0061   0019                  ; Режим передачи
0062   0019 21 03 F0         LXI	H, CTL_PORT
0063   001C 36 90            MVI	M, SEND_MODE
0064   001E 2B               DCX	H		; HL = DATA_PORT
0065   001F             
0066   001F                  ; Код команды BOOT
0067   001F 36 13            MVI	M, 013h
0068   0021 CF               Rst	1
0069   0022 36 B4            MVI	M, 0B4h
0070   0024 CF               Rst	1
0071   0025 36 57            MVI	M, 057h
0072   0027 CF               Rst	1
0073   0028 36 00            MVI	M, 0
0074   002A CF               Rst	1
0075   002B             
0076   002B                  ; Режим приема  
0077   002B 23               INX	H		; HL = CTL_PORT
0078   002C 36 99            MVI	M, RECV_MODE
0079   002E 2B               DCX	H		; HL = DATA_PORT
0080   002F             
0081   002F                  ; Если есть синхронизация, то контроллер ответит ERR_START
0082   002F CF               Rst	1
0083   0030 FE 40            CPI	ERR_START
0084   0032 C2 17 00         JNZ	RetrySync
0085   0035             
0086   0035                  ; Дальше будет ERR_OK_WAIT, ERR_OK_RKS
0087   0035 D7               Rst	2
0088   0036 FE 47            CPI	ERR_OK_RKS
0089   0038 C2 08 00         JNZ	Rst1		; Ошибка, освобождаем шину и перезагрузка
0090   003B                  
0091   003B                  ; Удаляем из стека 0C000h
0092   003B C1               POP	B
0093   003C             
0094   003C                  ; Адрес загрузки в BC
0095   003C CF               Rst	1
0096   003D 4F               MOV	C, A
0097   003E CF               Rst	1
0098   003F 47               MOV	B, A
0099   0040             
0100   0040                  ; Сохраняем в стек адрес запуска
0101   0040 C5               PUSH	B
0102   0041             
0103   0041                  ; Подождать
0104   0041             RecvLoop:
0105   0041 D7               Rst	2
0106   0042 FE 44            CPI	ERR_OK_READ
0107   0044 CA 08 00         JZ		Rst1		; Всё загружено, освобождаем шину и запуск
0108   0047 B7               ORA	A
0109   0048 C2 00 C0         JNZ	0C000h	; Ошибка, перезагрузка (не отпускаем контроллер)
0110   004B             
0111   004B                  ; Принять очередной блок
0112   004B CF               Rst	1
0113   004C 5F               MOV	E, A
0114   004D CF               Rst	1
0115   004E 57               MOV	D, A
0116   004F             RecvBlock:
0117   004F CF               Rst	1
0118   0050 02               STAX	B
0119   0051 03               INX	B
0120   0052 1B               DCX	D
0121   0053 7B               MOV	A, E
0122   0054 B2               ORA	D
0123   0055 C2 4F 00         JNZ	RecvBlock
0124   0058 C3 41 00         JMP	RecvLoop
0125   005B             
0126   005B             .Endtasm: Number of errors = 0
